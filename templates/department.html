{% extends "layout.html" %}
{% block body %}
<h2>Department
	{% if department.alias %}
	<b>{{ department.alias }}</b> ({{ department.name }})
	{% else %}
	<b>{{ department.name }}</b>
	{% endif %}
	({{ worker_count }})
</h2>
{% if session.department_id == 0 %}
<label for="unit">Unit:</label>
<select name="unit" onchange="setDepartmentUnit(this);">
	<option value="">None</option>
	{%- for unit in units %}
	<option value="{{ unit.id }}" {% if department.unit.id==unit.id %}selected="selected" {% endif %}>
		{{- unit.name -}}
	</option>
	{%- endfor %}
</select>
<form action="{{ url_for('department', department_slug=department.slug) }}" method=post>
	<label for="alias">Alias </label>
	<input name="alias" type="text" value="{{  department.alias }}" />
	<input type="submit" value="Set alias" />
</form>
{% endif %}
<p>
	Chair: {{ department.chair | join(', ', attribute="email") or "None" }}
</p>
<script>
	function toggleParticipation(element) {
		fetch("/participation/" +
			element.dataset.worker + "/" +
			element.dataset.structure_test + "/" +
			(element.checked ? 1 : 0))
			.then(response => console.log(response));
	}
	function setDepartmentUnit(element) {
		console.log(element)
		fetch("/set-department-unit/" + element.value + "/{{ department.id }}")
			.then(response => console.log(response));

	}
</script>
<h3>Organized Workers</h3>
<table class="table table-striped table-hover">
	<thead>
		<tr>
			<th scope="col">Name</th>
			<th scope="col">Unit</th>
			<th scope="col">Contract</th>
			<th scope="col">E-Mail</th>
			<th scope="col">Phone</th>
			{% for structure_test in structure_tests %}
			<th scope="col"><abbr title="{{ structure_test.description }}">{{ structure_test.name }}</abbr></th>
			{% endfor %}
		</tr>
	</thead>
	<tbody>
		{% for worker in workers %}
		{% if worker.organizing_dept_id == department.id %}
		<tr {% if worker.updated !=last_updated %}class="worker-inactive" {% endif %}>
			<td scope="row">
				<a href="{{ url_for('worker', worker_id=worker.id) }}">
					{{ worker.name }}
				</a>
			</td>
			<td>{{ worker.unit }}</td>
			<td>{{ worker.contract }}</td>
			<td>{% if worker.email %}<a href="mailto:{{ worker.email }}">{{ worker.email }}</a>{% else %}Unknown{% endif %}</td>
			<td>{% if worker.phone %}<a href="sms:{{ worker.phone }}">{{ worker.phone }}</a>{% else %}Unknown{% endif %}</td>
			{% for structure_test in structure_tests %}
			<th>
				<input type="checkbox"
					data-worker="{{ worker.id }}"
					data-structure_test="{{ structure_test.id }}"
					name="{{ structure_test.name }}"
					onchange="toggleParticipation(this);"
					{{ "checked" if structure_test.id in worker.participated }}>
			</th>
			{% endfor %}
		</tr>
		{% endif %}
		{% endfor %}
	</tbody>
</table>
<h3>Externally organized workers</h3>
<table class="table table-striped table-hover">
	<thead>
		<tr>
			<th scope="col">Name</th>
			<th scope="col">Unit</th>
			<th scope="col">Contract</th>
			<th scope="col">E-Mail</th>
			<th scope="col">Phone</th>
		</tr>
	</thead>
	<tbody>
		{% for worker in workers %}
		{% if worker.organizing_dept_id != department.id %}
		<tr {% if worker.updated !=last_updated %}class="worker-inactive" {% endif %}>
			<td scope="row">
				<a href="{{ url_for('worker', worker_id=worker.id) }}">
					{{ worker.name }}
				</a>
			</td>
			<td>{{ worker.unit }}</td>
			<td>{{ worker.contract }}</td>
			<td>{% if worker.email %}<a href="mailto:{{ worker.email }}">{{ worker.email }}</a>{% else %}Unknown{% endif
				%}</td>
			<td>{{ worker.phone or "Unknown" }}</td>
		</tr>
		{% endif %}
		{% endfor %}
	</tbody>
</table>
{% endblock %}
